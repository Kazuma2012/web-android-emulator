<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Web Android Emulator</title>
<style>
  body { margin:0; background:#000; display:flex; justify-content:center; align-items:center; height:100vh; }
  canvas { border:1px solid #444; }
</style>
</head>
<body>
<canvas id="screen" width="1024" height="768"></canvas>
<script>
const ws = new WebSocket('ws://' + window.location.hostname + ':8081');
const pc = new RTCPeerConnection();

const canvas = document.getElementById('screen');
const ctx = canvas.getContext('2d');
const video = document.createElement('video');
video.autoplay = true;

video.onplay = () => {
  function draw() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    requestAnimationFrame(draw);
  }
  draw();
};

pc.ontrack = e => {
  video.srcObject = e.streams[0];
};

ws.onmessage = async e => {
  const data = JSON.parse(e.data);
  if(data.type==='answer'){
    await pc.setRemoteDescription({ type:'answer', sdp: data.sdp });
  }
};

(async () => {
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ type:'offer', sdp: offer.sdp }));
})();

document.addEventListener('keydown', e => ws.send(JSON.stringify({ type:'keydown', key:e.key })));
document.addEventListener('keyup', e => ws.send(JSON.stringify({ type:'keyup', key:e.key })));
</script>
</body>
</html>
